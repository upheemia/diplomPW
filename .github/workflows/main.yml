name: E2E

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
        uses: actions/setup-node@v5
        with:
          node-version: lts/*
          
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
        run: npm i
        
      - name: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—ã
        run: npx playwright install --with-deps

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Allure Commandline
        run: |
          # –°–∫–∞—á–∏–≤–∞–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Allure
          sudo wget https://github.com/allure-framework/allure2/releases/download/2.24.0/allure_2.24.0-1_all.deb
          sudo dpkg -i allure_2.24.0-1_all.deb
          sudo apt-get install -f
          allure --version
        
      - name: –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
        run: npm t
        env:
          STEP: ${{vars.STEP}}
          SECRET: ${{secrets.MYSUPERSECRET}}
        continue-on-error: true
        
      - name: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Allure –æ—Ç—á–µ—Ç–∞
        if: always()
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ allure-results..."
          if [ -d "allure-results" ]; then
            echo "‚úÖ allure-results –Ω–∞–π–¥–µ–Ω, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç..."
            ls -la allure-results/
            allure generate allure-results --clean -o allure-report
            echo "üìä –û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:"
            find allure-report -name "*.json" | head -10
          else
            echo "‚ùå allure-results –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—â–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã..."
            find . -name "*.json" -path "*/test-results*" | head -10
          fi

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
        if: always()
        run: |
          echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
          ls -la
          echo ""
          echo "üìä –°–æ–¥–µ—Ä–∂–∏–º–æ–µ allure-report:"
          ls -la allure-report/ 2>/dev/null || echo "allure-report –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          echo ""
          echo "üîç –ò—â–µ–º summary.json:"
          find . -name "summary.json" 2>/dev/null || echo "summary.json –Ω–µ –Ω–∞–π–¥–µ–Ω"
        
      - name: –°–æ—Ö—Ä–∞–Ω—è–µ–º Allure –æ—Ç—á–µ—Ç
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        continue-on-error: true
        with:
          name: allure-report
          path: allure-report
          retention-days: 30
          
      - name: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
        if: always()
        run: node scripts/telegram-notify.js
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_SERVER_URL: ${{ github.server_url }}    